<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Microsoft YaHei:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="前言EventBus 使用发布&#x2F;订阅者模式，能够很好的进行模块之间的通信、解耦。以前一直停留在会用的层次，为了探究底层实现阅读了其源码实现，这也是继 Volley 以外我第二个阅读的框架源码。">
<meta property="og:type" content="article">
<meta property="og:title" content="EventBus 源码分析">
<meta property="og:url" content="http://yoursite.com/2018/12/15/EventBus%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="何富威的博客">
<meta property="og:description" content="前言EventBus 使用发布&#x2F;订阅者模式，能够很好的进行模块之间的通信、解耦。以前一直停留在会用的层次，为了探究底层实现阅读了其源码实现，这也是继 Volley 以外我第二个阅读的框架源码。">
<meta property="og:image" content="http://yoursite.com/2018/12/15/EventBus%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E.png">
<meta property="article:published_time" content="2018-12-15T01:12:46.000Z">
<meta property="article:modified_time" content="2020-05-06T05:45:12.394Z">
<meta property="article:author" content="何富威">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2018/12/15/EventBus%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/15/EventBus 源码分析/"/>





  <title>EventBus 源码分析 | 何富威的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8dd458e5cf03e833389caa5705955567";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">何富威的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-Android" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/15/EventBus%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="何富威">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何富威的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">EventBus 源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-15T09:12:46+08:00">
                2018-12-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>EventBus 使用发布/订阅者模式，能够很好的进行模块之间的通信、解耦。以前一直停留在会用的层次，为了探究底层实现阅读了其源码实现，这也是继 Volley 以外我第二个阅读的框架源码。<a id="more"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>EventBus 仓库地址为：<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">https://github.com/greenrobot/EventBus</a> 。官方给出以下一张图来帮助理解。</p>
<p><img src="/2018/12/15/EventBus%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E.png" alt="官方说明"></p>
<p>Publisher 使用 post 方法发送 Event ，Subscribe 在 onEvent 方法中接收 Event。据官方介绍 EventBus 有如下优点：</p>
<ul>
<li>简化组件间的交流。<ul>
<li>分离事件发送至和接收者。</li>
<li>更好的处理 Activities、Fragments、Background threads。</li>
<li>避免复杂且易出错的依赖关系和生命周期问题。</li>
</ul>
</li>
<li>使你的代码更简单。</li>
<li>速度快。</li>
<li>库较小。</li>
<li>使用该库的 APP 多。</li>
<li>拥有一些高级功能比如指定分发线程，设置订阅者优先级等。</li>
</ul>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>这里以 EventBusSecondActivity 通知 EventBusFirstActivity 为例，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">data class <span class="title">MessageEvent</span><span class="params">()</span> <span class="comment">// 1</span></span></span><br><span class="line"><span class="function">class EventBusFirstActivity : <span class="title">AppCompatActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onCreate</span><span class="params">(savedInstanceState: Bundle?)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_eventbus_first)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN, sticky = <span class="keyword">false</span>)</span><br><span class="line">    <span class="function">fun <span class="title">onReceiveEvent</span><span class="params">(msg: MessageEvent)</span> </span>&#123; <span class="comment">// 2</span></span><br><span class="line">        Log.d(<span class="string">"Receive message!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onStart</span><span class="params">()</span> </span>&#123; <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        EventBus.getDefault().register(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">override fun <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop()</span><br><span class="line">        EventBus.getDefault().unregister(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">fun <span class="title">jump</span><span class="params">(view: View)</span> </span>&#123;</span><br><span class="line">        startActivity(Intent(<span class="keyword">this</span>, EventBusSecondActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line">class EventBusSecondActivity : AppCompatActivity() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onCreate</span><span class="params">(savedInstanceState: Bundle?)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_eventbus_second)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">fun <span class="title">send</span><span class="params">(view: View)</span> </span>&#123;</span><br><span class="line">        EventBus.getDefault().post(MessageEvent())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>定义事件类： MessageEvent ，如果需要额外信息可以添加字段。</li>
<li>准备订阅者：声明以及注解订阅方法 onReceiveEvent ，可选 threadMode、sticky 、priority 。</li>
<li>注册订阅者：调用  <code>EventBus.getDefault().register(this)</code> 。</li>
<li>发送事件：调用  <code>EventBus.getDefault().post(MessageEvent())</code> 。</li>
</ol>
<p>经过以上四步，EventBusFirstActivity.onReceiveEvent 就会被执行。下面来分析下源码实现，首先第一步没什么好说的，从 Subscribe 注解开始说起。</p>
<h2 id="Subscribe-注解"><a href="#Subscribe-注解" class="headerlink" title="Subscribe 注解"></a>Subscribe 注解</h2><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subscribe &#123;</span><br><span class="line">    <span class="function">ThreadMode <span class="title">threadMode</span><span class="params">()</span> <span class="keyword">default</span> ThreadMode.POSTING</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">sticky</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">priority</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一共有以下三个属性：</p>
<ul>
<li>threadMode 表示注解的方法需要在哪个线程执行。可选值为（<strong>当前线程为执行 post 方法的线程</strong>）：<ol>
<li>POSTING，直接在当前线程调用。</li>
<li>MAIN，如果当前线程是主线程那么在当前直接调用，如果不是那么切换线程到主线程调用，因此调用线程一定是主线程。</li>
<li>MAIN_ORDERD，对比 MAIN ，其不判断当前是哪个线程，全部切换到主线程调用，因此调用线程一定是主线程。</li>
<li>BACKGROUND，如果当前线程是主线程那么切换到子线程中调用，并且多个事件是串行处理的，如果不是那么直接在当前线程调用，因此调用线程一定是子线程。</li>
<li>ASYNC，对比 BACKGROUND ，其不判断当前是哪个线程，全部切换到子线程中调用，并且多个事件是并行处理的，因此调用线程一定是子线程。</li>
</ol>
</li>
<li>sticky 表示是否接收在注册前已经发送的粘性事件。</li>
<li>priority 表示订阅方法调用的优先级，只对于相同的 threadMode 生效。</li>
</ul>
<h2 id="EventBus-register"><a href="#EventBus-register" class="headerlink" title="EventBus.register"></a>EventBus.register</h2><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(DEFAULT_BUILDER);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123; <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (EventBus<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                defaultInstance = <span class="keyword">new</span> EventBus();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultInstance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">            subscribe(subscriber, subscriberMethod); <span class="comment">// 3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>双重校验锁单例模式，但是 EventBus 的构造器不是私有的，并且还可以通过 EventBusBuilder.build 创建实例，这里先只考虑使用 EventBus.getDefault 的情况。</li>
<li>调用 SubscriberMethodFinder.findSubscriberMethods 查询类内所有注解了 @Subscribe 的方法。</li>
<li>对每个查询到的方法执行 EventBus.subscribe 方法。</li>
</ol>
<h3 id="SubscriberMethodFinder-findSubscriberMethods"><a href="#SubscriberMethodFinder-findSubscriberMethods" class="headerlink" title="SubscriberMethodFinder.findSubscriberMethods"></a>SubscriberMethodFinder.findSubscriberMethods</h3><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ignoreGeneratedIndex) &#123; <span class="comment">// 2</span></span><br><span class="line">        subscriberMethods = findUsingReflection(subscriberClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriberMethods = findUsingInfo(subscriberClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123; <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</span><br><span class="line">                                    + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        METHOD_CACHE.put(subscriberClass, subscriberMethods); <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果 <code>METHOD_CACHE</code>（ConcurrentHashMap） 里面已经存在了，那么使用缓存。</li>
<li>默认 <code>ignoreGeneratedIndex</code> （是否忽略 APT 生成的 Index ）为 false，因此会走到  <code>findUsingInfo(subscriberClass)</code> 。</li>
<li>如果在类中没找到注解了 @Subscribe 的方法那么抛出异常。</li>
<li>将找到的方法放入 <code>METHOD_CACHE</code> 进行缓存。</li>
</ol>
<h4 id="SubscriberMethodFinder-findUsingInfo"><a href="#SubscriberMethodFinder-findUsingInfo" class="headerlink" title="SubscriberMethodFinder.findUsingInfo"></a>SubscriberMethodFinder.findUsingInfo</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    FindState findState = prepareFindState(); <span class="comment">// 1</span></span><br><span class="line">    findState.initForSubscriber(subscriberClass); <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        findState.subscriberInfo = getSubscriberInfo(findState); <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</span><br><span class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</span><br><span class="line">                <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</span><br><span class="line">                    findState.subscriberMethods.add(subscriberMethod);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            findUsingReflectionInSingleClass(findState); <span class="comment">// 4</span></span><br><span class="line">        &#125;</span><br><span class="line">        findState.moveToSuperclass(); <span class="comment">// 5</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState); <span class="comment">// 6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>从缓存中取出或者创建一个实例，注：FindState 只要为了寻找出订阅者中哪些方法算合法订阅。</li>
<li>将 <code>findState</code> 中的 <code>subscribeClass</code>、<code>clazz</code> 字段都置为 <code>subscribeClass</code> ，为寻找方法做准备。</li>
<li>根据 <code>findState</code> 找出订阅信息，如果不使用插件，这里一开始会返回 null。</li>
<li>调用 <code>findUsingReflectionInSingleClass</code> 找出 <code>findState.clazz</code> 类中所有符合的方法。</li>
<li>调用 <code>findState.moveToSuperclass</code> 将 <code>findState.class</code> 变为其父类。</li>
<li>调用 <code>getMethodsAndRelease</code> </li>
</ol>
<h5 id="SubscriberMethodFinder-prepareFindState"><a href="#SubscriberMethodFinder-prepareFindState" class="headerlink" title="SubscriberMethodFinder.prepareFindState"></a>SubscriberMethodFinder.prepareFindState</h5><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> FindState <span class="title">prepareFindState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</span><br><span class="line">            FindState state = FIND_STATE_POOL[i];</span><br><span class="line">            <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                FIND_STATE_POOL[i] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FindState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 <code>FIND_STATE_POOL</code> 有 FindState 实例，那么取出一个，否则新建一个实例。</p>
<h5 id="SubscriberMethodFinder-initForSubscriber"><a href="#SubscriberMethodFinder-initForSubscriber" class="headerlink" title="SubscriberMethodFinder.initForSubscriber"></a>SubscriberMethodFinder.initForSubscriber</h5><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initForSubscriber</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.subscriberClass = clazz = subscriberClass;</span><br><span class="line">    skipSuperClasses = <span class="keyword">false</span>;</span><br><span class="line">    subscriberInfo = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 <code>subscribeClass</code>、<code>clazz</code> 字段都置为 <code>subscribeClass</code> ，为寻找方法做准备，clazz 会不断改变，从当前类到其父类。</p>
<h5 id="SubscriberMethodFinder-findUsingReflectionInSingleClass"><a href="#SubscriberMethodFinder-findUsingReflectionInSingleClass" class="headerlink" title="SubscriberMethodFinder.findUsingReflectionInSingleClass"></a>SubscriberMethodFinder.findUsingReflectionInSingleClass</h5><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">    Method[] methods;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        methods = findState.clazz.getDeclaredMethods(); <span class="comment">// 1</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            methods = findState.clazz.getMethods();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LinkageError error) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(msg, error);</span><br><span class="line">        &#125;</span><br><span class="line">        findState.skipSuperClasses = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="keyword">int</span> modifiers = method.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123; <span class="comment">// 2</span></span><br><span class="line">            Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">            <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123; <span class="comment">// 2</span></span><br><span class="line">                Subscribe subscribeAnnotation = method.getAnnotation(Subscribe<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">// 2</span></span><br><span class="line">                <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123; <span class="comment">// 3</span></span><br><span class="line">                        ThreadMode threadMode = subscribeAnnotation.threadMode();</span><br><span class="line">                        findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</span><br><span class="line">                                                                     subscribeAnnotation.priority(), subscribeAnnotation.sticky())); <span class="comment">// 4</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe<span class="class">.<span class="keyword">class</span>)) </span>&#123; <span class="comment">// 5</span></span><br><span class="line">                String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</span><br><span class="line">                                            <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe<span class="class">.<span class="keyword">class</span>)) </span>&#123; <span class="comment">// 7</span></span><br><span class="line">            String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</span><br><span class="line">                                        <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>getDeclaredMethod</code>  速度比 <code>getMethod</code> 快，前者获取的是当前类的所有方法，后者获取的是当前类及其父类的所有公有方法，如果使用了 <code>getMethod</code>  那么就跳过从父类中寻找方法。</li>
<li><code>method</code> 必须是满足，可见性为 publish、非静态、非抽象、参数一个、 @Subscribe 注解，否则跳过。 </li>
<li>执行 <strong><code>findState.checkAdd</code></strong> 存储订阅方法，这个方法很难理解但是很重要，决定了该方法要不要。</li>
<li>将符合条件的方法封装成 SubscriberMethod 实例，加入到 FindState 的 <code>subscriberMethods</code> 中。</li>
<li>各种开启严格模式，抛出异常的情况。</li>
</ol>
<h6 id="FindState-checkAdd"><a href="#FindState-checkAdd" class="headerlink" title="FindState.checkAdd"></a>FindState.checkAdd</h6><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkAdd</span><span class="params">(Method method, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">    Object existing = anyMethodByEventType.put(eventType, method);</span><br><span class="line">    <span class="keyword">if</span> (existing == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (existing <span class="keyword">instanceof</span> Method) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!checkAddWithMethodSignature((Method) existing, eventType)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">            &#125;</span><br><span class="line">            anyMethodByEventType.put(eventType, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> checkAddWithMethodSignature(method, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkAddWithMethodSignature</span><span class="params">(Method method, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">    methodKeyBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">    methodKeyBuilder.append(method.getName());</span><br><span class="line">    methodKeyBuilder.append(<span class="string">'&gt;'</span>).append(eventType.getName());</span><br><span class="line">    String methodKey = methodKeyBuilder.toString();</span><br><span class="line">    Class&lt;?&gt; methodClass = method.getDeclaringClass();</span><br><span class="line">    Class&lt;?&gt; methodClassOld = subscriberClassByMethodKey.put(methodKey, methodClass);</span><br><span class="line">    <span class="keyword">if</span> (methodClassOld == <span class="keyword">null</span> || methodClassOld.isAssignableFrom(methodClass)) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriberClassByMethodKey.put(methodKey, methodClassOld);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于方法相对比较难以理解，这里以类 A 存在两个接收 Message 类实例的方法 a1、a2 为例。</p>
<ol>
<li>a1 方法进入，Message 事件还没存在于 <code>anyMethodByEventType</code> ，那么 <code>existing</code> 为 null ，方法直接返回 true。</li>
<li>a2 方法进入，Message 事件已经存在于 <code>anyMethodByEventType</code>，那么 <code>existing</code> 不为空，执行 <code>checkAddWithMethodSignature</code> 将 a1 方法传入，a1 的 methodKey 不存在于 <code>subscriberClassByMethodKey</code> ，那么 <code>methodClassOld</code> 为空，直接返回 true ，然后直接把当前 <strong>FindState</strong> 实例放入 <code>anyMethodByEventType</code> ，原先的 a1 被替换成 FindState 实例，接着执行第二次 <code>checkAddWithMethodSignature</code> 将 a2 方法传入，a2 的 methodKey 不存在于 <code>subscriberClassByMethodKey</code> ，那么 <code>methodClassOld</code> 为空，直接返回 true ， 来看看现在内存情况，<code>anyMethodByEventType</code> 存放 Message - FindState 直接的映射，<code>subscriberClassByMethodKey</code> 存放 a1 - A、b1 - B 。</li>
<li>经过上述两步，应该基本明白了，如果订阅类一个事件就对应一个方法，那么 <code>anyMethodByEventType</code> 就已经够用了，内部存放 Message - Method 映射，如果一个事件对应多个方法，那么 <code>anyMethodByEventType</code> 不够用，内部存放 Message - FindState 映射。</li>
<li>再说说注释一处，这里其实考虑的也挺多，假设 A 类有方法 a（接收 Message1）、b（接收 Messages2）、a（接收 Message 2），第二个 a 在代码一处判断为 false || true ，会将同名不同参方法添加，再假设 SuperA 类有方法 a ，A 重写方法 a，这时候代码一处就变成了 false || false ，不将已被子类重写的父类方法缓存。</li>
</ol>
<h5 id="FindState-moveToSuperClass"><a href="#FindState-moveToSuperClass" class="headerlink" title="FindState.moveToSuperClass"></a>FindState.moveToSuperClass</h5><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToSuperclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (skipSuperClasses) &#123;</span><br><span class="line">        clazz = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clazz = clazz.getSuperclass();</span><br><span class="line">        String clazzName = clazz.getName();</span><br><span class="line">        <span class="keyword">if</span> (clazzName.startsWith(<span class="string">"java."</span>) || clazzName.startsWith(<span class="string">"javax."</span>) ||</span><br><span class="line">            clazzName.startsWith(<span class="string">"android."</span>) || clazzName.startsWith(<span class="string">"androidx."</span>)) &#123;</span><br><span class="line">            clazz = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不跳过查询父类，将 FindState 的 <code>clazz</code> 字段变成其父类的 Class 实例，如果类全名遇到 java. 、javax. 、android. 、androidx. 开头那么跳过。</p>
<h5 id="SubscriberMethodFinder-getMethodsAndRelease"><a href="#SubscriberMethodFinder-getMethodsAndRelease" class="headerlink" title="SubscriberMethodFinder.getMethodsAndRelease"></a>SubscriberMethodFinder.getMethodsAndRelease</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">getMethodsAndRelease</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;(findState.subscriberMethods);</span><br><span class="line">    findState.recycle();</span><br><span class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FIND_STATE_POOL[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                FIND_STATE_POOL[i] = findState;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 FindState 对象重置并回收。思考：<strong>是否有必要这么设计 FindState ？</strong> 我认为如果就便于理解层面来看，可以使用 Map&lt;Class, Set&lt;String&gt;&gt; 替代 FindState 内部的两个 Map，首先消息类型 Class 如果不一致，那么出现重名方法的可能性就只有重写父类方法了，可以简简单单通过 contains 进行判断，忽略掉重写的父类方法。</p>
<p>回到 EventBus.register ，看看 <code>subscribe</code> 方法。</p>
<h3 id="EventBus-subscribe"><a href="#EventBus-subscribe" class="headerlink" title="EventBus.subscribe"></a>EventBus.subscribe</h3><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line">    Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod); <span class="comment">// 1</span></span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;(); <span class="comment">// 2</span></span><br><span class="line">        subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123; <span class="comment">// 3</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></span><br><span class="line">                                        + eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123; <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">            subscriptions.add(i, newSubscription);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        typesBySubscriber.put(subscriber, subscribedEvents); <span class="comment">// 5</span></span><br><span class="line">    &#125;</span><br><span class="line">    subscribedEvents.add(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123; <span class="comment">// 6</span></span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    Object stickyEvent = entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object stickyEvent = stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>将订阅者对象与找到的方法封装成 Subscription 对象。</li>
<li>维护数据结构 Map&lt;Class, CopyOnWriteArrayList&lt;Subscription&gt;&gt; key 为事件的 Class 对象，value 为接收该事件的所有订阅。</li>
<li>Subscription 类重写了 equals 方法，如果订阅者对象一样，并且内部的订阅方法也一样那么抛出异常。</li>
<li>按照优先级顺序插入到 CopyOnWriteArrayList 中。</li>
<li>维护数据结构 Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; key 为订阅者对象，value 为该类所有事件的 Class 列表。</li>
<li>处理粘性事件，稍后再解释。</li>
</ol>
<p>注册流程已经完成，下面看下发送流程。</p>
<h2 id="EventBus-post"><a href="#EventBus-post" class="headerlink" title="EventBus.post"></a>EventBus.post</h2><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    PostingThreadState postingState = currentPostingThreadState.get(); <span class="comment">// 1</span></span><br><span class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</span><br><span class="line">    eventQueue.add(event);</span><br><span class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</span><br><span class="line">        postingState.isMainThread = isMainThread();</span><br><span class="line">        postingState.isPosting = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</span><br><span class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState); <span class="comment">// 2</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            postingState.isPosting = <span class="keyword">false</span>;</span><br><span class="line">            postingState.isMainThread = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>获取当前线程的 PostThreadState 实例。</li>
<li>执行 <code>postSingleEvent</code> 方法</li>
</ol>
<h3 id="EventBus-postSingleEvent"><a href="#EventBus-postSingleEvent" class="headerlink" title="EventBus.postSingleEvent"></a>EventBus.postSingleEvent</h3><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</span><br><span class="line">    Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass); <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</span><br><span class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz); <span class="comment">// 2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass); <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!subscriptionFound) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</span><br><span class="line">            logger.log(Level.FINE, <span class="string">"No subscribers registered for event "</span> + eventClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent<span class="class">.<span class="keyword">class</span> &amp;&amp;</span></span><br><span class="line"><span class="class">            <span class="title">eventClass</span> !</span>= SubscriberExceptionEvent<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>默认情况下 <code>eventInheritance</code> 为 true ，该属性表示是否发送父事件，比如发送 Message 事件，那么同时也会发送 Parcelable 事件，因为 Message 实现了 Parcelable 接口。</li>
<li>执行 <code>postSingleEventForEventType</code> 进行事件的发送。</li>
</ol>
<h4 id="EventBus-postSingleEventForEventType"><a href="#EventBus-postSingleEventForEventType" class="headerlink" title="EventBus.postSingleEventForEventType"></a>EventBus.postSingleEventForEventType</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        subscriptions = subscriptionsByEventType.get(eventClass); <span class="comment">// 1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</span><br><span class="line">            postingState.event = event;</span><br><span class="line">            postingState.subscription = subscription;</span><br><span class="line">            <span class="keyword">boolean</span> aborted;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                postToSubscription(subscription, event, postingState.isMainThread); <span class="comment">// 2</span></span><br><span class="line">                aborted = postingState.canceled;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                postingState.event = <span class="keyword">null</span>;</span><br><span class="line">                postingState.subscription = <span class="keyword">null</span>;</span><br><span class="line">                postingState.canceled = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>获取原先注册时收集为接收该事件的 subscriptions 。</li>
<li>执行 <code>postToSubscription</code> 进行事件的发送。</li>
</ol>
<h5 id="EventBus-postToSubscription"><a href="#EventBus-postToSubscription" class="headerlink" title="EventBus.postToSubscription"></a>EventBus.postToSubscription</h5><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        handleSubscriberException(subscription, event, e.getCause());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>POSTING，直接在当前线程使用反射调用。</li>
<li>MAIN，如果当前是主线程，那么直接调用，否则执行 <code>mainThreadPoster.enqueue</code> 。</li>
<li>MAIN_ORDERED，由于默认情况 <code>mainThreadPoster</code> 不为空，于是执行 <code>mainThreadPoster.enqueue</code> 。</li>
<li>BACKGROUND，如果当前是主线程，那么执行 <code>backgroundPoster.enqueue</code>，否则直接反射调用。</li>
<li>ASYNC，执行 <code>asyncPoster.enqueue</code> 。</li>
</ol>
<h6 id="HandlerPoster-enqueue"><a href="#HandlerPoster-enqueue" class="headerlink" title="HandlerPoster.enqueue"></a>HandlerPoster.enqueue</h6><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        queue.enqueue(pendingPost); <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (!handlerActive) &#123;</span><br><span class="line">            handlerActive = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123; <span class="comment">// 2</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> rescheduled = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> started = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            PendingPost pendingPost = queue.poll(); <span class="comment">// 3</span></span><br><span class="line">            <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    pendingPost = queue.poll(); <span class="comment">// 3</span></span><br><span class="line">                    <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        handlerActive = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            eventBus.invokeSubscriber(pendingPost); <span class="comment">// 3</span></span><br><span class="line">            <span class="keyword">long</span> timeInMethod = SystemClock.uptimeMillis() - started;</span><br><span class="line">            <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123; <span class="comment">// 4</span></span><br><span class="line">                <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                rescheduled = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        handlerActive = rescheduled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> </span>&#123;</span><br><span class="line">    Object event = pendingPost.event;</span><br><span class="line">    Subscription subscription = pendingPost.subscription;</span><br><span class="line">    PendingPost.releasePendingPost(pendingPost);</span><br><span class="line">    <span class="keyword">if</span> (subscription.active) &#123;</span><br><span class="line">        invokeSubscriber(subscription, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>从 PendingPost 池中取出或者创建一个 PendingPost 实例，并将其放入队列中（单链表实现）。</li>
<li>如果 <code>handleMessage</code> 的 when 循环没有执行，那么发送消息使其执行。</li>
<li>从队列中取出消息，如果取不到则使用同步再取一次，可能情况是其它线程添加进去了当前线程不可见，使用同步强制去主存读一次，取到后回收 PendingPost 实例，然后反射执行。</li>
<li>如果事件总执行时间超过 <code>maxMillisInsideHandleMessage</code> 那么重新发送事件，意图是防止卡顿，给 UI 刷新执行时间，不然一直卡在这循环了。</li>
</ol>
<h6 id="BackgroundPoster-enqueue"><a href="#BackgroundPoster-enqueue" class="headerlink" title="BackgroundPoster.enqueue"></a>BackgroundPoster.enqueue</h6><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        queue.enqueue(pendingPost); <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (!executorRunning) &#123; <span class="comment">// 2</span></span><br><span class="line">            executorRunning = <span class="keyword">true</span>;</span><br><span class="line">            eventBus.getExecutorService().execute(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                PendingPost pendingPost = queue.poll(<span class="number">1000</span>); <span class="comment">// 3</span></span><br><span class="line">                <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        pendingPost = queue.poll();</span><br><span class="line">                        <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            executorRunning = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                eventBus.invokeSubscriber(pendingPost); <span class="comment">// 3</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            eventBus.getLogger().log(Level.WARNING, Thread.currentThread().getName() + <span class="string">" was interruppted"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        executorRunning = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>从 PendingPost 池中取出或者创建一个 PendingPost 实例，并将其放入队列中（单链表实现）。</li>
<li>如果当前 run 方法还没被执行，那么将其放入线程池中执行，默认线程池为 <code>Executors.newCachedThreadPool</code> 由于无线程上界几乎可以立即执行。</li>
<li>从队列中取出消息，如果1秒内取不到则使用同步再取一次，可能情况是其它线程添加进去了当前线程不可见，使用同步强制去主存读一次，取到后回收 PendingPost 实例，然后反射执行，<strong>事件是顺序执行的</strong>，必须等到上个事件处理完毕后，下一个才能被处理。</li>
</ol>
<h6 id="AsyncPoster-enqueue"><a href="#AsyncPoster-enqueue" class="headerlink" title="AsyncPoster.enqueue"></a>AsyncPoster.enqueue</h6><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">    queue.enqueue(pendingPost);</span><br><span class="line">    eventBus.getExecutorService().execute(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PendingPost pendingPost = queue.poll();</span><br><span class="line">    <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取 PendingPost 对象，将其放入队列，然后将自身放入线程池执行 run 方法，在内部再取出 PendingPost 对象，反射执行方法调用，与 BackgroundPoster 不同的是，<strong>事件是并发执行的</strong>，只要有事件就立马执行，下一个不需要等上一个事件处理完毕。</p>
<p>至此，注册订阅以及发送事件流程已经完成了，下面来看看取消注册。</p>
<h2 id="EventBus-unregister"><a href="#EventBus-unregister" class="headerlink" title="EventBus.unregister"></a>EventBus.unregister</h2><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</span><br><span class="line">            unsubscribeByEventType(subscriber, eventType);</span><br><span class="line">        &#125;</span><br><span class="line">        typesBySubscriber.remove(subscriber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.log(Level.WARNING, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            Subscription subscription = subscriptions.get(i);</span><br><span class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</span><br><span class="line">                subscription.active = <span class="keyword">false</span>;</span><br><span class="line">                subscriptions.remove(i);</span><br><span class="line">                i--;</span><br><span class="line">                size--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先从 <code>typesBySubscriber</code> 中取出订阅者类拥有的所有订阅类型，然后再根据订阅类型找到对应的 <code>subscriptions</code> ，并且遍历如果发现其订阅者是 <code>subscriber</code> 将其 <code>activie</code> 置为 false（防止订阅方法再被执行） 然后将其移除。就完成了注册和解注册，接着看看粘性事件。</p>
<h2 id="EventBus-postSticky"><a href="#EventBus-postSticky" class="headerlink" title="EventBus.postSticky"></a>EventBus.postSticky</h2><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (stickyEvents) &#123;</span><br><span class="line">        stickyEvents.put(event.getClass(), event);</span><br><span class="line">    &#125;</span><br><span class="line">    post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相对于非粘性事件，只是多了往 <code>stickyEvents</code> 里面添加事件类以及事件对象，想想也是，粘性事件相比非粘性只是在注册时可能会立即执行，那么回到 EventBus.subscribe 。</p>
<h3 id="EventBus-subscribe-1"><a href="#EventBus-subscribe-1" class="headerlink" title="EventBus.subscribe"></a>EventBus.subscribe</h3><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123; <span class="comment">// 2</span></span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    Object stickyEvent = entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object stickyEvent = stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先如果注解属性 sticky 为 true 才会进入。</li>
<li>默认 <code>eventInheritance</code> 为 true 。</li>
<li>从 <code>stickyEvents</code> 中取出已缓存的粘性事件对象，如果订阅的事件是粘性事件或者是其父类，那么执行 <code>checkPostStickyEventToSubscription</code> 。</li>
<li>如果  <code>eventInheritance</code> 为 false ，那么从 <code>stickyEvents</code> 中取出已缓存的粘性事件对象，如果订阅的事件是粘性事件，那么执行 <code>checkPostStickyEventToSubscription</code> 。</li>
</ol>
<h4 id="EventBus-checkPostStickyEventToSubscription"><a href="#EventBus-checkPostStickyEventToSubscription" class="headerlink" title="EventBus.checkPostStickyEventToSubscription"></a>EventBus.checkPostStickyEventToSubscription</h4><p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPostStickyEventToSubscription</span><span class="params">(Subscription newSubscription, Object stickyEvent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (stickyEvent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        postToSubscription(newSubscription, stickyEvent, isMainThread());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又回到了 <code>postToSubscription</code> 根据 ThreadMode 在对应线程反射执行方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>EventBus 的核心是以下三个 Map：</p>
<ol>
<li>Map&lt;Object, List&lt;Class&gt; 用于解除注册。</li>
<li>Map&lt;Class, CopyOnWriteArrayList&lt;Subscription&gt;&gt; 用于分发事件。</li>
<li>Map&lt;Class, Object&gt; 用于粘性事件。</li>
</ol>
<p>基于反射的 EventBus 会对性能有一点影响，后续看一看其提供的 APT 插件。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/13/Volley%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="next" title="Volley 源码分析">
                <i class="fa fa-chevron-left"></i> Volley 源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/08/OkHttp%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="prev" title="OkHttp 源码分析">
                OkHttp 源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="何富威" />
            
              <p class="site-author-name" itemprop="name">何富威</p>
              <p class="site-description motion-element" itemprop="description">行百里者半九十</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">2.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本用法"><span class="nav-number">3.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Subscribe-注解"><span class="nav-number">4.</span> <span class="nav-text">Subscribe 注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus-register"><span class="nav-number">5.</span> <span class="nav-text">EventBus.register</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SubscriberMethodFinder-findSubscriberMethods"><span class="nav-number">5.1.</span> <span class="nav-text">SubscriberMethodFinder.findSubscriberMethods</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SubscriberMethodFinder-findUsingInfo"><span class="nav-number">5.1.1.</span> <span class="nav-text">SubscriberMethodFinder.findUsingInfo</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SubscriberMethodFinder-prepareFindState"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">SubscriberMethodFinder.prepareFindState</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SubscriberMethodFinder-initForSubscriber"><span class="nav-number">5.1.1.2.</span> <span class="nav-text">SubscriberMethodFinder.initForSubscriber</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SubscriberMethodFinder-findUsingReflectionInSingleClass"><span class="nav-number">5.1.1.3.</span> <span class="nav-text">SubscriberMethodFinder.findUsingReflectionInSingleClass</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#FindState-checkAdd"><span class="nav-number">5.1.1.3.1.</span> <span class="nav-text">FindState.checkAdd</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FindState-moveToSuperClass"><span class="nav-number">5.1.1.4.</span> <span class="nav-text">FindState.moveToSuperClass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SubscriberMethodFinder-getMethodsAndRelease"><span class="nav-number">5.1.1.5.</span> <span class="nav-text">SubscriberMethodFinder.getMethodsAndRelease</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-subscribe"><span class="nav-number">5.2.</span> <span class="nav-text">EventBus.subscribe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus-post"><span class="nav-number">6.</span> <span class="nav-text">EventBus.post</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-postSingleEvent"><span class="nav-number">6.1.</span> <span class="nav-text">EventBus.postSingleEvent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EventBus-postSingleEventForEventType"><span class="nav-number">6.1.1.</span> <span class="nav-text">EventBus.postSingleEventForEventType</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#EventBus-postToSubscription"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">EventBus.postToSubscription</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#HandlerPoster-enqueue"><span class="nav-number">6.1.1.1.1.</span> <span class="nav-text">HandlerPoster.enqueue</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#BackgroundPoster-enqueue"><span class="nav-number">6.1.1.1.2.</span> <span class="nav-text">BackgroundPoster.enqueue</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#AsyncPoster-enqueue"><span class="nav-number">6.1.1.1.3.</span> <span class="nav-text">AsyncPoster.enqueue</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus-unregister"><span class="nav-number">7.</span> <span class="nav-text">EventBus.unregister</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus-postSticky"><span class="nav-number">8.</span> <span class="nav-text">EventBus.postSticky</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-subscribe-1"><span class="nav-number">8.1.</span> <span class="nav-text">EventBus.subscribe</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EventBus-checkPostStickyEventToSubscription"><span class="nav-number">8.1.1.</span> <span class="nav-text">EventBus.checkPostStickyEventToSubscription</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">何富威</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
